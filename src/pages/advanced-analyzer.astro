---
import Layout from '../layouts/Layout.astro'
import Section from '../components/ui/Section.astro'
import Row from '../components/ui/Row.astro'
import Col from '../components/ui/Col.astro'
import { eq } from 'drizzle-orm';
import { db } from '../db';
import { sessions } from '../db/schema';

const sessionToken = Astro.cookies.get("app_auth_token")?.value;

if (!sessionToken) {
  return Astro.redirect("/login");
}

const userInfo = await db.query.sessions.findFirst({
  where: eq(sessions.id, sessionToken),
  with: {
    user: {
      columns: {
        email: true,
      },
    },
  },
});

const userEmail = userInfo?.user?.email || 'No email found';


interface ApiKey {
  name?: string;
  api_key: string;
  plan?: string;
  requests?: number;
  renewal_date?: string;
}

let apiKeysData: ApiKey[] = [];

if (userEmail !== 'No email found') {
  try {
    const response = await fetch(`https://analyzemydream-api-key.vercel.app/api_keys?email=${encodeURIComponent(userEmail)}`);
    const result = await response.json();
    
    if (response.ok) {
      apiKeysData = result.api_keys || [];
    } else {
      console.error('API Error:', result.error || 'An error occurred. Please try again.');
    }
  } catch (error) {
    console.error('Fetch Error:', error);
  }
}

const hasApiKeys = apiKeysData.length > 0;

function censorApiKey(apiKey: string): string {
  return `AMD_*****${apiKey.slice(-4)}`;
}

const SEO = {
  title: 'Analise Meu Sonho | Analisador de Sonhos com IA Avançada',
  description: 'Experimente uma análise detalhada de sonhos com nossa ferramenta de Analisador de Sonhos com IA Avançada, usando parâmetros predefinidos com base em pesquisas acadêmicas.'
};

---
<Layout title={SEO.title} description={SEO.description}>
<Section id="analyze-intro" padding="none" classes="bg-neutral-50 dark:bg-neutral-900">
    <Row>
        <Col span="2" />
        <Col span="8" align="center">
            <br><h2 class="text-4xl font-semibold mb-4">Obtenha acesso a uma análise profunda de sonhos através de nossa ferramenta <strong>Analisador de Sonhos com IA Avançada</strong>.</h2>
            <label for="dreamDescription" class="block text-lg font-medium mb-2">
                Projetado para revelar mensagens e insights significativos dentro dos seus sonhos usando parâmetros predefinidos, que são apoiados por pesquisas acadêmicas.
            </label>
            
        </Col>
    </Row>
</Section>

<Section id="dream-form" padding="none" classes="bg-neutral-50 dark:bg-neutral-900">
    {hasApiKeys ? (
    <Row>
        <Col align="center">
            <form id="dreamForm" class="space-y-4">
                <p class="text-sm text-gray-500 dark:text-gray-300 mb-4">
                    Por favor, use esta ferramenta de forma responsável. Os resultados são destinados apenas para orientação geral.  <strong><a href="/faq" style="color: #7BC7C7; text-decoration: none;">Saiba Mais.</a></strong>
                </p>   
                <div class="p-4 bg-white dark:bg-neutral-800 shadow-md rounded-lg space-y-4" style="border-radius:20px;">
                    <!-- Tipo de Sonho -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Tipo de Sonho</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="radio" name="dreamType" value="Experienced" /> Experienciado</label>
                            <label class="mr-4"><input type="radio" name="dreamType" value="Lucid" /> Lúcido</label>
                            <label class="mr-4"><input type="radio" name="dreamType" value="Blurred" /> Embaçado</label>
                            <label><input type="radio" name="dreamType" value="N/A" /> N/A</label>
                        </div>
                    </div>
    
                    <!-- Importância do Sonho -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Importância do Sonho</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="radio" name="dreamImportance" value="Insignificant" /> Insignificante</label>
                            <label class="mr-4"><input type="radio" name="dreamImportance" value="Neutral" /> Neutro</label>
                            <label class="mr-4"><input type="radio" name="dreamImportance" value="Very Important" /> Muito Importante</label>
                            <label><input type="radio" name="dreamImportance" value="N/A" /> N/A</label>
                        </div>
                    </div>
    
                    <!-- Emoções Principais -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Emoções Principais</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="checkbox" name="mainEmotions" value="Happiness" /> Felicidade</label>
                            <label class="mr-4"><input type="checkbox" name="mainEmotions" value="Sadness" /> Tristeza</label>
                            <label class="mr-4"><input type="checkbox" name="mainEmotions" value="Fear" /> Medo</label>
                            <label class="mr-4"><input type="checkbox" name="mainEmotions" value="Anxiety" /> Ansiedade</label>
                            <label class="mr-4"><input type="checkbox" name="mainEmotions" value="Anger" /> Raiva</label>
                            <label><input type="checkbox" name="mainEmotions" value="N/A" /> N/A</label>
                        </div>
                    </div>
    
                    <!-- Contexto do Sonho -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Contexto do Sonho</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="radio" name="dreamContext" value="Familiar" /> Familiar</label>
                            <label class="mr-4"><input type="radio" name="dreamContext" value="Unknown" /> Desconhecido</label>
                            <label class="mr-4"><input type="radio" name="dreamContext" value="Natural Environment" /> Ambiente Natural</label>
                            <label class="mr-4"><input type="radio" name="dreamContext" value="Urban Environment" /> Ambiente Urbano</label>
                            <label><input type="radio" name="dreamContext" value="N/A" /> N/A</label>
                        </div>
                    </div>
    
                    <!-- Estado do Sonho -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Estado do Sonho</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="radio" name="dreamState" value="Refreshed" /> Revigorado</label>
                            <label class="mr-4"><input type="radio" name="dreamState" value="Tired" /> Cansado</label>
                            <label class="mr-4"><input type="radio" name="dreamState" value="Confusado" /> Confuso</label>
                            <label class="mr-4"><input type="radio" name="dreamState" value="Indifferent" /> Indiferente</label>
                            <label><input type="radio" name="dreamState" value="N/A" /> N/A</label>
                        </div>
                    </div>
    
                    <!-- Frequência dos Sonhos -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Frequência dos Sonhos</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="radio" name="dreamFrequency" value="Rarely" /> Raramente</label>
                            <label class="mr-4"><input type="radio" name="dreamFrequency" value="Occasionally" /> Ocasionalmente</label>
                            <label class="mr-4"><input type="radio" name="dreamFrequency" value="Frequently" /> Frequentemente</label>
                            <label class="mr-4"><input type="radio" name="dreamFrequency" value="Always" /> Sempre</label>
                            <label><input type="radio" name="dreamFrequency" value="N/A" /> N/A</label>
                        </div>
                    </div>

                    <!-- Expectativas do Sonho -->
                    <div class="card">
                        <h3 class="text-lg font-medium mb-2">Expectativas do Sonho</h3>
                        <div class="flex flex-wrap" style="justify-content:center;">
                            <label class="mr-4"><input type="radio" name="dreamExpectations" value="Problem Resolution" /> Resolução de Problemas</label>
                            <label class="mr-4"><input type="radio" name="dreamExpectations" value="Personal Insight" /> Insight Pessoal</label>
                            <label class="mr-4"><input type="radio" name="dreamExpectations" value="Warnings" /> Avisos</label>
                            <label class="mr-4"><input type="radio" name="dreamExpectations" value="No Expectation" /> Sem Expectativa</label>
                            <label><input type="radio" name="dreamExpectations" value="N/A" /> N/A</label>
                        </div>
                    </div>
                </div>
                <select id="apiKeySelect" name="apiKey" class="w-full p-2 border border-gray-300 rounded" style="background-color: transparent;  border-radius: 10px; text-align: center;">
                {apiKeysData.map((apiKey) => (
                    <option value={apiKey.api_key}>
                    {apiKey.plan ? `${apiKey.plan} Plano` : 'Sem Plano'} - 
                    Solicitações: {apiKey.requests ? apiKey.requests : 'Sem dados'} - {censorApiKey(apiKey.api_key)}
                    </option>
                ))}
                </select>
                <p class="text-sm text-gray-500 dark:text-gray-300 mb-4">
                    Forneça uma descrição detalhada do seu sonho e, opcionalmente, selecione uma variedade de parâmetros predefinidos. Nossa IA fornecerá uma análise aprofundada adaptada aos seus inputs.
                </p>
                 <!-- Entrada do Sonho -->
                <textarea id="dreamDescription" name="dreamDescription" style="background:transparent; border-radius:10px;" rows="6" cols="50" minlength="30" required class="w-full p-2 border border-gray-300 rounded" placeholder="Digite uma descrição detalhada do seu sonho..."></textarea>

                <p id="analysisResult" class="mt-4" style="text-align: center;"></p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="analyzeButton" type="submit" class="relative flex items-center justify-center text-white py-2 px-4 rounded-lg hover:bg-blue-600" style="background-color: rgba(123, 199, 199, var(--tw-bg-opacity));">
                        <span id="buttonText" style="font-weight: 700; font-size: 0.875rem;">Analisar Meu Sonho</span>
                    </button>
                </div>
                <br>
            </form>
        </Col>
        <Col span="2" />
    </Row>
    ) : (
        <div style="text-align:center;">
            <br>
          <p class="text-gray-700 dark:text-gray-300">Parece que você não tem nenhuma <strong>chave de API</strong> disponível no momento.</p>
          <p class="text-gray-700 dark:text-gray-300">Para desbloquear acesso total, considere selecionar um plano que atenda às suas necessidades.</p>
          <div class="flex justify-center">
            <a href="/pricing" class="w-52 flex items-center justify-center text-white py-2 px-4 rounded-lg hover:bg-blue-600" style="background-color: rgba(123, 199, 199, var(--tw-bg-opacity));">Explorar Planos</a>
          </div>
        </div>
        <br>
        )}
</Section>

</Layout>


<script type="module">
    document.getElementById('dreamForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const apiKeySelect = document.getElementById('apiKeySelect');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const dreamDescription = document.getElementById('dreamDescription');
        const analysisResult = document.getElementById('analysisResult');
        const dreamType = document.querySelector('input[name="dreamType"]:checked')?.value || "N/A";
        const dreamImportance = document.querySelector('input[name="dreamImportance"]:checked')?.value || "N/A";
        const mainEmotions = Array.from(document.querySelectorAll('input[name="mainEmotions"]:checked')).map(el => el.value).join(", ") || "N/A";
        const dreamContext = document.querySelector('input[name="dreamContext"]:checked')?.value || "N/A";
        const dreamState = document.querySelector('input[name="dreamState"]:checked')?.value || "N/A";
        const dreamFrequency = document.querySelector('input[name="dreamFrequency"]:checked')?.value || "N/A";
        const dreamExpectations = document.querySelector('input[name="dreamExpectations"]:checked')?.value || "N/A";
        
        const additionalInfo = `
            Dream Type: ${dreamType}
            Dream Importance: ${dreamImportance}
            Main Emotions: ${mainEmotions}
            Dream Context: ${dreamContext}
            Dream State: ${dreamState}
            Dream Frequency: ${dreamFrequency}
            Dream Expectations: ${dreamExpectations}
        `;

        const fullDescription = `${dreamDescription.value}\n\n${additionalInfo}`;

        if (!analyzeButton || !buttonText || !dreamDescription || !apiKeySelect || !analysisResult) {
            console.error('One or more elements are missing.');
            return;
        }

        buttonText.textContent = 'Analisando...';
        analyzeButton.disabled = true;
        const selectedApiKey = apiKeySelect.value;

        try {
            const response = await fetch(`https://analyzemydream-api.vercel.app/analyzer/${selectedApiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dream_description: fullDescription,
                    lang: 'br'
                }),
            });

            const result = await response.json();
            if (response.ok) {
                analysisResult.innerHTML = `<strong>Advanced-AI Dream Analysis:</strong> ${result.analysis}`;
                buttonText.textContent = 'Try Again';
                analyzeButton.removeEventListener('click', handleFormSubmit);
                analyzeButton.addEventListener('click', handleClearInput);
            } else {
                analysisResult.textContent = result.error;
                buttonText.textContent = 'Analyze Your Dream';
            }
        } catch (error) {
            analysisResult.textContent = 'An error occurred. Please try again.';
            buttonText.textContent = 'Analyze Your Dream';
        } finally {
            analyzeButton.disabled = false;
        }

        function handleClearInput() {
            dreamDescription.value = '';
            analysisResult.textContent = '';
            buttonText.textContent = 'Analyze Your Dream';
            analyzeButton.removeEventListener('click', handleClearInput);
            analyzeButton.addEventListener('click', handleFormSubmit);
        }

        function handleFormSubmit() {
            document.getElementById('dreamForm').dispatchEvent(new Event('submit'));
        }
    });
</script>
<style>
    .tabs-container {
      margin-bottom: 20px;
    }
    
    .tab-item {
      display: inline-block;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      font-size: 16px;
    }
    
    .tab-item.active {
      background-color: #7BC7C7;
      color: white;
    }
    
    .tab-item:hover {
      background-color: rgba(123, 199, 199, 0.2);
      border-color: #7BC7C7;
    }
    
    @media (prefers-color-scheme: dark) {
      .tab-item {
        color: #94A3B8;
      }
    }

    @media (max-width: 1024px) {
    .tabs {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }

    .tab-item {
        flex: 1 1 calc(33.333% - 10px);
        margin-bottom: 10px;
        text-align: center;
    } 
  }
</style>
